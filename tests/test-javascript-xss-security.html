<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TableCrafter JavaScript XSS Security Tests</title>
    <style>
        .test-results { margin: 20px; font-family: Arial, sans-serif; }
        .test-pass { color: green; }
        .test-fail { color: red; }
        .test-section { margin: 20px 0; padding: 10px; border: 1px solid #ccc; }
    </style>
</head>
<body>
    <h1>TableCrafter JavaScript XSS Security Tests</h1>
    <div id="test-results" class="test-results"></div>
    <div id="test-container" style="display: none;"></div>

    <script>
        // Mock TableCrafter class with security methods
        class MockTableCrafter {
            constructor() {
                this.testResults = [];
            }

            /**
             * SECURITY: Check if HTML content is trusted (from server-side rendering)
             * Only allow specific safe HTML patterns
             */
            isTrustedHTML(html) {
                if (typeof html !== 'string') return false;
                
                // Allow specific trusted HTML patterns from server-side rendering
                const trustedPatterns = [
                    /^<span class="tc-badge tc-(yes|no)">(?:Yes|No)<\/span>$/,
                    /^<img src="[^"]*" style="[^"]*" alt="[^"]*" loading="lazy">$/,
                    /^<a href="mailto:[^"]*" title="[^"]*">[^<]*<\/a>$/,
                    /^<time datetime="[^"]*">[^<]*<\/time>$/,
                    /^<a href="https?:\/\/[^"]*" target="_blank" rel="noopener noreferrer" title="[^"]*">[^<]*<\/a>$/,
                    /^<div class="tc-tag-list">(<span class="tc-tag">[^<]*<\/span>)*(<span class="tc-tag tc-more">\+\d+ more<\/span>)?<\/div>$/,
                    /^<span class="tc-tag">[^<]*<\/span>$/
                ];

                return trustedPatterns.some(pattern => pattern.test(html));
            }

            /**
             * SECURITY: Safely set innerHTML with validation
             */
            safeSetInnerHTML(element, html) {
                if (this.isTrustedHTML(html)) {
                    element.innerHTML = html;
                } else {
                    element.textContent = html;
                }
            }

            /**
             * SECURITY: Create safe DOM element with escaped content
             */
            createSafeElement(tagName, content, attributes = {}) {
                const element = document.createElement(tagName);
                
                // Set text content safely
                if (content) {
                    element.textContent = content;
                }
                
                // Set attributes safely
                for (const [key, value] of Object.entries(attributes)) {
                    element.setAttribute(key, String(value));
                }
                
                return element;
            }

            /**
             * Escape HTML entities
             */
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // Test runner methods
            runTest(testName, testFn) {
                try {
                    const result = testFn();
                    if (result === true) {
                        this.testResults.push({name: testName, status: 'PASS', error: null});
                        console.log(`✓ ${testName}`);
                    } else {
                        this.testResults.push({name: testName, status: 'FAIL', error: 'Test returned false'});
                        console.log(`✗ ${testName}: Test returned false`);
                    }
                } catch (error) {
                    this.testResults.push({name: testName, status: 'FAIL', error: error.message});
                    console.log(`✗ ${testName}: ${error.message}`);
                }
            }

            runAllTests() {
                console.log('Running TableCrafter XSS Security Tests...\n');

                // Test trusted HTML detection
                this.runTest('Trusted HTML: Valid badge recognized', () => {
                    return this.isTrustedHTML('<span class="tc-badge tc-yes">Yes</span>');
                });

                this.runTest('Trusted HTML: Valid image recognized', () => {
                    return this.isTrustedHTML('<img src="test.jpg" style="max-width: 100px; height: auto; display: block;" alt="Table image" loading="lazy">');
                });

                this.runTest('Trusted HTML: Valid mailto link recognized', () => {
                    return this.isTrustedHTML('<a href="mailto:user@example.com" title="Send email to user@example.com">user@example.com</a>');
                });

                this.runTest('Untrusted HTML: Script tag rejected', () => {
                    return !this.isTrustedHTML('<script>alert("XSS")</script>');
                });

                this.runTest('Untrusted HTML: Malicious image rejected', () => {
                    return !this.isTrustedHTML('<img src=x onerror=alert("XSS")>');
                });

                this.runTest('Untrusted HTML: JavaScript URL rejected', () => {
                    return !this.isTrustedHTML('<a href="javascript:alert(1)">click</a>');
                });

                this.runTest('Untrusted HTML: Event handlers rejected', () => {
                    return !this.isTrustedHTML('<span onclick="alert(1)">click me</span>');
                });

                this.runTest('Untrusted HTML: Iframe rejected', () => {
                    return !this.isTrustedHTML('<iframe src="javascript:alert(1)"></iframe>');
                });

                // Test safe innerHTML functionality
                this.runTest('Safe innerHTML: Trusted content allowed', () => {
                    const testContainer = document.createElement('div');
                    const trustedHTML = '<span class="tc-badge tc-yes">Yes</span>';
                    this.safeSetInnerHTML(testContainer, trustedHTML);
                    return testContainer.innerHTML === trustedHTML;
                });

                this.runTest('Safe innerHTML: Malicious content escaped', () => {
                    const testContainer = document.createElement('div');
                    const maliciousHTML = '<script>alert("XSS")</script>';
                    this.safeSetInnerHTML(testContainer, maliciousHTML);
                    return testContainer.innerHTML !== maliciousHTML && testContainer.textContent === maliciousHTML;
                });

                // Test DOM creation security
                this.runTest('Safe element creation: Text content escaped', () => {
                    const element = this.createSafeElement('div', '<script>alert("XSS")</script>');
                    return element.textContent === '<script>alert("XSS")</script>' && 
                           element.innerHTML !== '<script>alert("XSS")</script>';
                });

                this.runTest('Safe element creation: Attributes escaped', () => {
                    const element = this.createSafeElement('div', 'content', {
                        'data-value': '<script>alert("XSS")</script>'
                    });
                    return element.getAttribute('data-value') === '<script>alert("XSS")</script>';
                });

                // Test HTML escaping
                this.runTest('HTML escaping: Special characters escaped', () => {
                    const escaped = this.escapeHtml('<>&"\'');
                    return escaped.includes('&lt;') && escaped.includes('&gt;') && escaped.includes('&amp;');
                });

                // Test comprehensive XSS payload resistance
                const xssPayloads = [
                    '<script>alert("XSS")</script>',
                    'javascript:alert("XSS")',
                    'onmouseover="alert(1)"',
                    '<img src=x onerror=alert("XSS")>',
                    '<svg onload=alert("XSS")>',
                    'data:text/html,<script>alert("XSS")</script>',
                    '<iframe src="javascript:alert(1)"></iframe>',
                    '<object data="javascript:alert(1)"></object>',
                    '<embed src="javascript:alert(1)">',
                    '<div onclick="alert(1)">test</div>',
                    '<a href="javascript:alert(1)">click</a>',
                    'vbscript:alert("XSS")',
                ];

                xssPayloads.forEach((payload, index) => {
                    this.runTest(`XSS Resistance ${index + 1}: ${payload.substring(0, 20)}...`, () => {
                        // Test that payload is not recognized as trusted
                        const notTrusted = !this.isTrustedHTML(payload);
                        
                        // Test that safe innerHTML escapes it
                        const testContainer = document.createElement('div');
                        this.safeSetInnerHTML(testContainer, payload);
                        const safelyEscaped = testContainer.innerHTML !== payload;
                        
                        return notTrusted && safelyEscaped;
                    });
                });

                // Test edge cases
                this.runTest('Edge case: Empty string handled', () => {
                    return !this.isTrustedHTML('');
                });

                this.runTest('Edge case: Non-string input handled', () => {
                    return !this.isTrustedHTML(null) && !this.isTrustedHTML(undefined) && !this.isTrustedHTML(123);
                });

                this.runTest('Edge case: Very long trusted pattern', () => {
                    const longTag = '<span class="tc-tag">' + 'A'.repeat(1000) + '</span>';
                    return this.isTrustedHTML(longTag);
                });

                // Render results
                this.renderResults();
            }

            renderResults() {
                const container = document.getElementById('test-results');
                const passed = this.testResults.filter(t => t.status === 'PASS').length;
                const failed = this.testResults.filter(t => t.status === 'FAIL').length;

                let html = `
                    <div class="test-section">
                        <h2>Test Summary</h2>
                        <p><strong>Total Tests:</strong> ${this.testResults.length}</p>
                        <p class="test-pass"><strong>Passed:</strong> ${passed}</p>
                        <p class="test-fail"><strong>Failed:</strong> ${failed}</p>
                    </div>
                `;

                if (failed > 0) {
                    html += `
                        <div class="test-section">
                            <h3>Failed Tests</h3>
                            <ul>
                    `;

                    this.testResults.filter(t => t.status === 'FAIL').forEach(test => {
                        html += `<li class="test-fail">${test.name}: ${test.error || 'Failed'}</li>`;
                    });

                    html += '</ul></div>';
                }

                html += `
                    <div class="test-section">
                        <h3>All Test Results</h3>
                        <ul>
                `;

                this.testResults.forEach(test => {
                    const className = test.status === 'PASS' ? 'test-pass' : 'test-fail';
                    html += `<li class="${className}">${test.status}: ${test.name}</li>`;
                });

                html += '</ul></div>';

                container.innerHTML = html;

                // Final security check: Verify no XSS executed during tests
                if (window.xssExecuted) {
                    container.innerHTML += '<div class="test-fail"><strong>CRITICAL: XSS payload executed during tests!</strong></div>';
                } else {
                    container.innerHTML += '<div class="test-pass"><strong>Security Verified: No XSS payloads executed during tests</strong></div>';
                }
            }
        }

        // Global flag to detect if any XSS payload executes
        window.xssExecuted = false;
        window.alert = function(msg) {
            console.warn('XSS Alert blocked:', msg);
            window.xssExecuted = true;
            return false;
        };

        // Run tests when page loads
        document.addEventListener('DOMContentLoaded', function() {
            const testRunner = new MockTableCrafter();
            testRunner.runAllTests();
        });
    </script>
</body>
</html>